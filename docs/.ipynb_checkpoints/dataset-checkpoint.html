<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stover Dataset Viewer</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 20px;
    background: #f4f4f4;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  h1 {
    text-align: center;
    margin-bottom: 10px;
  }
  .controls {
    text-align: center;
    margin: 10px 0 20px 0;
  }
  table {
    width: 85%;
    max-width: 1200px;
    border-collapse: collapse;
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-radius: 8px;
    overflow: hidden;
  }
  th {
    background: #333;
    color: white;
    padding: 10px;
    font-size: 1rem;
  }
  td {
    vertical-align: top;
    padding: 8px;
    border: 1px solid #ccc;
    text-align: center;
  }
  img {
    max-width: 256px;
    height: auto;
    border: 1px solid #ddd;
    border-radius: 4px;
  }
  .stats {
    text-align: left;
    font-size: 0.9em;
  }
  button {
    padding: 5px 12px;
    margin: 0 8px;
    font-size: 1em;
    border-radius: 5px;
    border: none;
    background-color: #333;
    color: white;
    cursor: pointer;
  }
  button:hover {
    background-color: #555;
  }
  #pageInfo {
    font-weight: bold;
    margin: 0 10px;
  }
</style>
    
</head>
<body>
<h1>Stover Dataset Viewer</h1>
<div class="controls">
  <button id="prevBtn">Previous</button>
  <span id="pageInfo"></span>
  <button id="nextBtn">Next</button>
</div>

<table id="imageTable">
  <thead>
    <tr>
      <th>Info</th>
      <th>RGB image</th>
      <th>Ground truth label</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const baseRGB = "https://raw.githubusercontent.com/soilwater/stover/main/dataset_v1/image_data/";
const baseMask = "https://raw.githubusercontent.com/soilwater/stover/main/dataset_v1/label_data_092025/";
const totalImages = 800;
const perPage = 100;
let currentPage = 0;

// Converts grayscale mask to colored mask (brown=soil, green=plant, yellow=residue)
async function recolorMask(url) {
  const img = new Image();
  img.crossOrigin = "Anonymous";
  return new Promise((resolve) => {
    img.onload = () => {
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0);
      const imageData = ctx.getImageData(0, 0, img.width, img.height);
      const data = imageData.data;
      let soil = 0, plant = 0, residue = 0;

      for (let i = 0; i < data.length; i += 4) {
        const v = data[i]; // grayscale value (0,1,2)
        if (v === 0) { data[i]=165; data[i+1]=42; data[i+2]=42; soil++; }       // brown
        else if (v === 1) { data[i]=0; data[i+1]=255; data[i+2]=0; plant++; } // green
        else if (v === 2) { data[i]=255; data[i+1]=255; data[i+2]=0; residue++; } // yellow
      }
      ctx.putImageData(imageData, 0, 0);
      const total = soil + plant + residue;
      resolve({
        url: canvas.toDataURL(),
        stats: {
          soil: (soil/total*100).toFixed(1),
          plant: (plant/total*100).toFixed(1),
          residue: (residue/total*100).toFixed(1)
        }
      });
    };
    img.onerror = () => resolve(null);
    img.src = url;
  });
}

function getImageNumber(index) {
  return index.toString().padStart(4, '0');
}

async function loadPage(page) {
  const tbody = document.querySelector("#imageTable tbody");
  tbody.innerHTML = "";
  const start = page * perPage;
  const end = Math.min(start + perPage, totalImages);
  document.getElementById("pageInfo").textContent = 
    `Showing ${start+1}-${end} of ${totalImages}`;

  for (let i = start + 1; i <= end; i++) {
    const imageNumber = getImageNumber(i);
    const rgbUrl = `${baseRGB}image_${imageNumber}.jpg`;
    const maskUrl = `${baseMask}label_${imageNumber}.png`;
    const maskResult = await recolorMask(maskUrl);
    const stats = maskResult?.stats || {soil: "-", plant: "-", residue: "-"};
    const row = document.createElement("tr");
    row.innerHTML = `
      <td class="stats">
        <strong>${imageNumber}</strong><br>
        Soil: ${stats.soil}%<br>
        Plant: ${stats.plant}%<br>
        Residue: ${stats.residue}%
      </td>
      <td><img src="${rgbUrl}" alt="RGB"></td>
      <td><img src="${maskResult?.url || maskUrl}" alt="Mask"></td>
    `;
    tbody.appendChild(row);
  }
}

document.getElementById("nextBtn").addEventListener("click", () => {
  if ((currentPage + 1) * perPage < totalImages) {
    currentPage++;
    loadPage(currentPage);
  }
});
document.getElementById("prevBtn").addEventListener("click", () => {
  if (currentPage > 0) {
    currentPage--;
    loadPage(currentPage);
  }
});

// initial load
loadPage(0);
</script>
</body>
</html>
