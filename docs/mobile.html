<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="icon" type="image/png" sizes="32x32" href="logo.ico">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#9051a3">
<title>Stover</title>
<script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
  const logo = new Image(); 
  logo.src = "logo_and_text.png";
  
  const model_version = "20250924191812";
  window.onload = () => document.getElementById("modelVersionText").textContent = `Running model v${model_version}`;
</script>

<style>
  :root {
    --slide-transition: 0.0s ease;
  }

  body {
    font-family: sans-serif;
    background: #fafafa;
    margin: 0;
    overflow: hidden;
  }

  html, body {
    overflow-x: hidden;       /* no horizontal scrolling for the main layout */
    touch-action: pan-y;      /* only allow vertical touch gestures */
    overscroll-behavior-x: none; /* prevent momentum scroll past edges */
  }



  .slide-container {
    display: flex;
    flex-wrap: nowrap;
    width: 300vw; /* 3 slides */
    height: 100vh;
    transition: transform var(--slide-transition);
  }

  section {
    flex: 0 0 100vw;
    height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    box-sizing: border-box;
    padding: 20px;
    text-align: center;
  }

  h2 {
    margin-bottom: 15px;
  }

  canvas {
    max-width: 90vw;
    max-height: 70vh;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    object-fit: contain;
  }

  nav {
    position: fixed;
    bottom: 12px;
    width: 100%;
    display: flex;
    justify-content: center;
    gap: 10px;
    z-index: 10;
  }

  button {
    padding: 10px 18px;
    border: none;
    border-radius: 6px;
    background-color: #9051a3;
    color: white;
    font-size: 15px;
    cursor: pointer;
  }

  button:hover:not(:disabled) {
    background-color: #9051a3;
  }

  button:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
  }

button.active {
  background-color: #5c0372; /* darker shade for active slide */
}

#percentages p {
  margin: 6px 0;
  font-size: 28px;
}

input[type=file] {
  font-size: 16px;
  margin-top: 10px;
}
 
.legend-box {
  display: inline-block;
  width: 14px;
  height: 14px;
  border: 1px solid black;
  margin-right: 2px;
  vertical-align: middle;
}

#info {
  text-align: left;
  max-width: 90vw;
  margin-top: 10px;
}

#info p {
  margin: 4px 0;
  font-size: 18px;
}

.image-name {
  margin-top: 8px;
  font-size: 16px;
  color: #333;
  text-align: center;
  word-break: break-word;
}

.emoji-list {
  list-style: none;       /* remove default bullets */
  padding-left: 0;        /* remove default padding */
  text-align: left;       /* align text to the left */
  margin: 0;
}

.emoji-list li {
  margin-bottom: 5px;     /* space between items */
  line-height: 1.4;
}


/* Hide the ugly native file input */
input[type=file] {
  display: none;
}

/* Style the custom label as a button */
.file-label {
  display: inline-block;
  border: 3px solid #282828;
  background-color: #ffffff;
  color: #282828;
  font-size: 22px;
  padding: 14px 26px;
  border-radius: 8px;
  cursor: pointer;
  margin-top: 30px;
  margin-bottom: 20px;
  text-align: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  transition: background-color 0.3s;
}

.file-label:hover {
  background-color: #ffffff;
}

.file-label:active {
  background-color: #9051a3;
}

.small-button {
  font-size: 14px;
  padding: 4px 10px;
  border-radius: 4px;
  background-color: #fafafa;
  color: #9051a3;
  border: 1px solid #9051a3;
  cursor: pointer;
  margin-top: 10px;
}
.small-button:hover {
  background-color: #9051a3;
  color: white;
}



@media (max-width: 600px) {
  h2 { font-size: 1.5em; }
  button { padding: 12px 20px; font-size: 17px; }
 }


/* Data */
.card-container {
  display: flex;
  flex-direction: column;
  gap: 10px;
  max-height: 60vh;
  overflow-y: auto;
  margin-top: 5px;
  margin-bottom: 2px;
  min-width: 300px;
}

.data-card {
  background-color: #fff;
  border: 1px solid #ccc;
  border-radius: 10px;
  padding: 10px 14px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  font-size: 0.9em;
  text-align: left;
}

.data-card p {
  margin: 2px 0;
}

.data-card .card-header {
  font-weight: bold;
  color: #9051a3;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.remove-card-btn {
  background: none;
  border: none;
  color: #b00;
  font-size: 1.2em;
  cursor: pointer;
  padding: 0;
}

.data-buttons button {
  padding: 6px 12px;
  font-size: 14px;
  background-color: #ffffff;
  color: #222;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  transition: background-color 0.2s ease;
}

.data-buttons button:hover {
  background-color: #f8f8f8;
}

.note-container {
  width: 100%;
  max-width: 512px;
  margin: 10px auto 0 auto; /* centers it under the image */
}

.note-container label {
  font-weight: 500;
  display: block;
  margin-bottom: 4px;
  text-align: left;
}

#noteInput {
  width: 100%;
  box-sizing: border-box;
  padding: 8px;
  border-radius: 8px;
  border: 1px solid #ccc;
  resize: none;
  font-size: 0.95rem;
}

#charCount {
  text-align: right;
  font-size: 0.8rem;
  color: #666;
  margin-top: 2px;
}


</style>
</head>
<body>
  <div class="slide-container" id="slides">
    <section id="new">
      <img src="logo_and_text.png" alt="Stover logo" class="logo" width="300 px", height="auto">

      <!--<h2>Select or capture a photo</h2>
       <input type="file" id="fileInput" accept="image/*" capture="environment">
      <input type="file" id="fileInput" accept="image/*">  -->
      
      <label for="fileInput" class="file-label"><b>Upload / Capture</b></label>
      <input type="file" id="fileInput" accept="image/*">
      <p id="statusMessage" style="margin-top:5px; font-size:14px; color:#000000; font-style:italic;"></p>

      <ul class="emoji-list" style="margin-top: 30x;">
        <li><b>Tips:</b></li>
        <li>üìè Hold camera 2‚Äì3 ft (60‚Äì90 cm) above ground</li>
        <li>‚òÄÔ∏è Avoid strong shadows</li>
        <li>üö´ Keep shoes, flags, and stakes out of frame</li>
        <li>üéØ Stover only captures the center of the image</li>
        <li>üì≤ Offline use: Share/Menu ‚Üí ‚ÄúAdd to Home‚Äù</li>
      </ul>

      <p id="modelVersionText" style="font-size: 0.8em; color: #666; margin-top: 15px;">
        <!-- text will be set by JS -->
      </p>
    </section>

    <section id="original">
      <h2>Original Image</h2>
      <canvas id="inputCanvas"></canvas>
      <div id="info">
        <p id="imageNameOriginal" class="image-name"></p>
      </div>
      <div class="note-container">
        <label for="noteInput">Add short note (optional):</label>
        <textarea
          id="noteInput"
          maxlength="40"
          rows="2"
          placeholder="e.g., field name, plot number"
        ></textarea>
        <div id="charCount">0 / 40</div>
      </div>

    </section>

    <section id="classified">
      <h2>Classified Image</h2>
      <canvas id="outputCanvas"></canvas>
      <div id="info">
        <p id="imageNameClassified" class="image-name"></p>
        <div id="percentages">Upload an image to see results.</div>
      </div>
      <button id="saveSummaryBtn" class="small-button">Export</button>
    </section>

    <section id="dataSection">
      <h2>Stored Data</h2>
      <p id="geoNote" style="font-size:0.9em; color:#666; margin: 2px;">
        Coordinates reflect your current location
      </p>
      <p style="font-size:0.9em; color:#666; margin: 2px;">Your data never leaves your device (no server involved)</p>

      <div id="cardContainer" class="card-container"></div>
      <p id="storageCount" style="font-size:0.9em; color:#666; margin-top:2px;"></p>

      <div class="data-buttons">
        <button id="downloadCsvBtn">‚¨áÔ∏è Download CSV</button>
        <button id="clearStorageBtn">üóëÔ∏è Clear All</button>
      </div>
    </section>
  </div>

  <nav>
    <button onclick="goToSlide(0)">New</button>
    <button id="btnOriginal" onclick="goToSlide(1)" disabled>Original</button>
    <button id="btnClassified" onclick="goToSlide(2)" disabled>Classified</button>
    <button id="btnData" onclick="goToSlide(3)" disabled>Data</button>
  </nav>



<script>
const slides = document.getElementById("slides");
const inputCanvas = document.getElementById("inputCanvas");
const outputCanvas = document.getElementById("outputCanvas");
const fileInput = document.getElementById("fileInput");
const percentagesDiv = document.getElementById("percentages");
const buttons = {
  original: document.getElementById("btnOriginal"),
  classified: document.getElementById("btnClassified"),
  data: document.getElementById("btnData"),
};


// Check if there is any data in localStorage
const storedData = localStorage.getItem("stoverData");
if (storedData && JSON.parse(storedData).length > 0) {
  buttons.data.disabled = false;  // enable Data button
} else {
  buttons.data.disabled = true;   // keep it disabled
}

let session, lastResults = {};

async function initModel() {
  session = await ort.InferenceSession.create("unet_20250924191812.onnx");
  console.log("‚úÖ Model loaded");
}

initModel();

function goToSlide(n) {
  slides.style.transform = `translateX(-${n * 100}vw)`;

  // Highlight active button
  document.querySelectorAll("nav button").forEach((btn, i) => {
    if (i === n) btn.classList.add("active");
    else btn.classList.remove("active");
  });

  // Populate table if user goes to Data
  if (n === 3) {  // replace 3 with your Table View slide index
    renderCards();
  }
}

function escapeForCSV(value) {
  if (value == null) return "";
  const escaped = String(value).replace(/"/g, '""');
  return `"${escaped}"`;
}

function enableButtons() {
  buttons.original.disabled = false;
  buttons.classified.disabled = false;
  buttons.data.disabled = false;
}

fileInput.addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const url = URL.createObjectURL(file);
  const img = new Image();

  document.getElementById("statusMessage").textContent = "Analyzing image...";

  // Show image name
  document.getElementById("imageNameOriginal").innerHTML = `<b>File: </b> ${file.name}`;
  document.getElementById("imageNameClassified").innerHTML = `<b>File: </b> ${file.name}`;

  img.onload = async () => {
    const minSide = Math.min(img.width, img.height);
    const sx = (img.width - minSide) / 2;
    const sy = (img.height - minSide) / 2;
    const ctx = inputCanvas.getContext("2d");
    inputCanvas.width = 512;
    inputCanvas.height = 512;
    ctx.drawImage(img, sx, sy, minSide, minSide, 0, 0, 512, 512);

    enableButtons();
    goToSlide(1);
    await classifyImage();
    document.getElementById("statusMessage").textContent = "";

    // Get the note input element
    const noteInput = document.getElementById("noteInput");

    // Clear it when a new image is loaded
    noteInput.value = "";

  };
  img.src = url;
});

async function classifyImage() {
  const ctx = inputCanvas.getContext("2d");
  const imageData = ctx.getImageData(0, 0, 512, 512);
  const { data } = imageData;
  const floatData = new Float32Array(3 * 512 * 512);

  for (let i = 0; i < 512 * 512; i++) {
    floatData[i] = data[i * 4] / 255.0;
    floatData[i + 512 * 512] = data[i * 4 + 1] / 255.0;
    floatData[i + 2 * 512 * 512] = data[i * 4 + 2] / 255.0;
  }

  const tensor = new ort.Tensor("float32", floatData, [1, 3, 512, 512]);
  const result = await session.run({ input: tensor });
  const output = result.output.data;

  const mask = new Uint8ClampedArray(512 * 512 * 4);
  const counts = [0, 0, 0]; // soil, plant, residue

  for (let i = 0; i < 512 * 512; i++) {
    const soil = output[i];
    const plant = output[i + 512 * 512];
    const residue = output[i + 2 * 512 * 512];
    const maxClass = soil > plant && soil > residue ? 0 :
                     plant > residue ? 1 : 2;
    counts[maxClass]++;

    let r=0,g=0,b=0;
    if (maxClass === 0) { r=139; g=69; b=19; }
    else if (maxClass === 1) { r=34; g=139; b=34; }
    else if (maxClass === 2) { r=255; g=215; b=0; }

    const idx = i * 4;
    mask[idx] = r; mask[idx+1] = g; mask[idx+2] = b; mask[idx+3] = 255;
  }

  outputCanvas.width = 512;
  outputCanvas.height = 512;
  outputCanvas.getContext("2d").putImageData(new ImageData(mask, 512, 512), 0, 0);

  const total = counts.reduce((a,b)=>a+b,0);
  const soilPct = (counts[0]/total*100).toFixed(1);
  const plantPct = (counts[1]/total*100).toFixed(1);
  const residuePct = (counts[2]/total*100).toFixed(1);
  const totalPct = ((counts[1] + counts[2])/total*100).toFixed(1);

  lastResults = { soilPct, plantPct, residuePct, totalPct };

  percentagesDiv.innerHTML = `
  <p><span class="legend-box" style="background-color: rgb(139,69,19);"></span><b>Soil:</b> ${soilPct}%</p>
  <p><span class="legend-box" style="background-color: rgb(34,139,34);"></span><b>Plant:</b> ${plantPct}%</p>
  <p><span class="legend-box" style="background-color: rgb(255,215,0);"></span><b>Residue:</b> ${residuePct}%</p>
  <p><b>Total cover:</b> ${totalPct}%</p>`;


  // Save to localStorage
  const fileName = document.getElementById("imageNameClassified").textContent.replace(/^File:\s*/, '');

  // Try to get location if available
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        saveImageData({
          fileName,
          timestamp: new Date().toISOString(),
          latitude: pos.coords.latitude,
          longitude: pos.coords.longitude,
          soil: lastResults.soilPct,
          plant: lastResults.plantPct,
          residue: lastResults.residuePct,
          totalCover: lastResults.totalPct,
          note: "" // Only variable not available after image classification. Default is empty string.
        });
      },
      () => {
        // fallback if location not available or denied
        saveImageData({
          fileName,
          timestamp: new Date().toISOString(),
          latitude: "",
          longitude: "",
          soil: lastResults.soilPct,
          plant: lastResults.plantPct,
          residue: lastResults.residuePct,
          totalCover: lastResults.totalPct,
          note: ""
        });
      }
    );
  } else {
    // no geolocation API
    saveImageData({
      fileName,
      timestamp: new Date().toISOString(),
      latitude: "",
      longitude: "",
      soil: lastResults.soilPct,
      plant: lastResults.plantPct,
      residue: lastResults.residuePct,
      totalCover: lastResults.totalPct,
      note: ""
    });
  }
}


const saveSummaryBtn = document.getElementById("saveSummaryBtn");

saveSummaryBtn.addEventListener("click", async () => {
  const inputCanvasEl = document.getElementById("inputCanvas");
  const outputCanvasEl = document.getElementById("outputCanvas");
  const noteInput = document.getElementById("noteInput").value.trim();

  // Text info
  const lines = [
    `File: ${document.getElementById("imageNameClassified").textContent.replace(/^File:\s*/, '')}`, // ensure "File:" prefix
    `Soil: ${lastResults.soilPct}%`,
    `Plant: ${lastResults.plantPct}%`,
    `Residue: ${lastResults.residuePct}%`,
    `Total Cover: ${lastResults.totalPct}%`
  ];

  const lineHeight = 28;
  const padding = 20;
  const hPad = 20; // horizontal padding

  const infoHeight = lines.length * lineHeight + padding;

  const width = Math.max(inputCanvasEl.width, outputCanvasEl.width) + 2 * hPad;
  const height = inputCanvasEl.height + outputCanvasEl.height + infoHeight + 3 * padding;

  // Create offscreen canvas
  const summaryCanvas = document.createElement("canvas");
  summaryCanvas.width = width;
  summaryCanvas.height = height;
  const ctx = summaryCanvas.getContext("2d", { willReadFrequently: true });


  // Fill background white
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0, 0, width, height);

  let y = padding;

  // Draw original image
  ctx.drawImage(inputCanvasEl, hPad, y, inputCanvasEl.width, inputCanvasEl.height);
  y += inputCanvasEl.height + padding;

  // Draw classified image
  ctx.drawImage(outputCanvasEl, hPad, y, outputCanvasEl.width, outputCanvasEl.height);
  y += outputCanvasEl.height + padding;

  // Draw info text and legend boxes
  ctx.font = "18px sans-serif";
  ctx.fillStyle = "#000000";

  // Legend colors
  const legendColors = [
    { color: "rgb(139,69,19)", label: "Soil" },
    { color: "rgb(34,139,34)", label: "Plant" },
    { color: "rgb(255,215,0)", label: "Residue" }
  ];

  // Draw File line
  ctx.fillText(lines[0], hPad, y);
  y += lineHeight;

  // Draw legend lines
  for (let i = 1; i <= 3; i++) {
    const xBox = hPad;
    const yBox = y - 18; // align with text
    ctx.fillStyle = legendColors[i-1].color;
    ctx.fillRect(xBox, yBox, 16, 16);

    ctx.fillStyle = "#000000";
    ctx.fillText(lines[i], xBox + 22, y);
    y += lineHeight;
  }

  // Draw Total Cover line
  ctx.fillText(lines[4], hPad, y);
  y += lineHeight;

  // Draw model line
  ctx.fillText(`Note: ${noteInput}`, hPad, y);


  // Draw logo
  const logoWidth = 80;
  const logoHeight = 80;
  const margin = 10;

  // Only draw if logo is already loaded
  if (logo.complete) {
    ctx.drawImage(
      logo,
      summaryCanvas.width - logoWidth - margin,
      summaryCanvas.height - logoHeight - margin,
      logoWidth,
      logoHeight
    );
  }


  // Trigger download as JPEG
  const link = document.createElement("a");
  const now = new Date();
  const pad = n => n.toString().padStart(2, "0");
  const timestamp = now.getFullYear().toString() +
                    pad(now.getMonth() + 1) +
                    pad(now.getDate()) +
                    pad(now.getHours()) +
                    pad(now.getMinutes()) +
                    pad(now.getSeconds());
  link.download = `stover_${timestamp}_v${model_version}.jpg`;
  link.href = summaryCanvas.toDataURL("image/jpeg", 0.95);
  link.click();
});



// Beginning of code for data cards

function saveImageData(entry) {
  const data = JSON.parse(localStorage.getItem("stoverData") || "[]");
  data.push(entry);
  localStorage.setItem("stoverData", JSON.stringify(data));
  updateStorageCount();

}

function renderCards() {
  const container = document.getElementById("cardContainer");
  container.innerHTML = "";

  const data = JSON.parse(localStorage.getItem("stoverData") || "[]");

  data.forEach((entry, index) => {
    const card = document.createElement("div");
    card.className = "data-card";

    card.innerHTML = `
      <div class="card-header">
        <span>Image #${index + 1}</span>
        <button class="remove-card-btn" title="Remove entry">√ó</button>
      </div>
      <p><b>File:</b> ${entry.fileName}</p>
      <p><b>Timestamp:</b> ${entry.timestamp}</p>
      <p><b>Latitude:</b> ${entry.latitude ?? "‚Äî"}</p>
      <p><b>Longitude:</b> ${entry.longitude ?? "‚Äî"}</p>
      <p><b>Soil:</b> ${entry.soil}%</p>
      <p><b>Plant:</b> ${entry.plant}%</p>
      <p><b>Residue:</b> ${entry.residue}%</p>
      <p><b>Total Cover:</b> ${entry.totalCover}%</p>
      <p><b>Note:</b> ${entry.note && entry.note.trim() !== "" ? entry.note : "None"}</p>
    `;

    // Add remove button logic
    card.querySelector(".remove-card-btn").addEventListener("click", () => {
      data.splice(index, 1);
      localStorage.setItem("stoverData", JSON.stringify(data));
      renderCards();
      updateStorageCount();
    });

    container.appendChild(card);
  });
  updateStorageCount();
}

document.getElementById("clearStorageBtn").addEventListener("click", () => {
  if (confirm("Are you sure you want to remove all saved data?")) {
    localStorage.removeItem("stoverData");
    renderCards();
    updateStorageCount();
  }
});


document.getElementById("downloadCsvBtn").addEventListener("click", () => {
  const data = JSON.parse(localStorage.getItem("stoverData") || "[]");
  if (!data.length) return;

  // Use same headers as table
  const headers = ["File","Timestamp","Latitude","Longitude","Soil","Plant","Residue","Total Cover","Note"];
  const csvRows = [headers.join(",")];

  data.forEach(row => {
    const values = [
      row.fileName ?? "",
      row.timestamp ?? "",
      row.latitude ?? "",
      row.longitude ?? "",
      row.soil ?? "",
      row.plant ?? "",
      row.residue ?? "",
      row.totalCover ?? "",
      escapeForCSV(row.note ?? "")
    ];
    csvRows.push(values.join(","));
  });

  const csvString = csvRows.join("\n");
  const blob = new Blob([csvString], {type: "text/csv"});
  const url = URL.createObjectURL(blob);

  const link = document.createElement("a");
  link.href = url;
  link.download = `stover_data_${new Date().toISOString().replace(/[:.]/g,"")}_v${model_version}.csv`;  
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
});

function updateStorageCount() {
  const stoverData = JSON.parse(localStorage.getItem("stoverData")) || [];
  const countEl = document.getElementById("storageCount");
  countEl.textContent = `You have ${stoverData.length} entr${stoverData.length === 1 ? "y" : "ies"}`;
}

// Render cards on page load
window.addEventListener("load", renderCards);



// Code for optional note
const noteInput = document.getElementById("noteInput");
const charCount = document.getElementById("charCount");

noteInput.addEventListener("input", () => {
  charCount.textContent = `${noteInput.value.length} / 40`;
});

noteInput.addEventListener("change", () => {
  const stoverData = JSON.parse(localStorage.getItem("stoverData") || "[]");
  if (stoverData.length === 0) return;

  stoverData[stoverData.length - 1].note = noteInput.value.trim() || "None";
  localStorage.setItem("stoverData", JSON.stringify(stoverData));
  renderCards();  // update card display
});



if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js')
    .then(() => console.log("‚úÖ Service Worker registered"))
    .catch(err => console.error("Service Worker registration failed:", err));
}

</script>

</body>
</html>
