<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="icon" type="image/png" sizes="32x32" href="logo.ico">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#9051a3">
<title>Stover</title>
<script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
  :root {
    --slide-transition: 0.5s ease;
  }

  body {
    font-family: sans-serif;
    background: #fafafa;
    margin: 0;
    overflow: hidden;
  }

  html, body {
    overflow-x: hidden;       /* no horizontal scrolling */
    touch-action: pan-y;      /* only allow vertical touch gestures */
    overscroll-behavior-x: none; /* prevent momentum scroll past edges */
  }


  .slide-container {
    display: flex;
    flex-wrap: nowrap;
    width: 300vw; /* 3 slides */
    height: 100vh;
    transition: transform var(--slide-transition);
  }

  section {
    flex: 0 0 100vw;
    height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    box-sizing: border-box;
    padding: 20px;
    text-align: center;
  }

  h2 {
    margin-bottom: 15px;
  }

  canvas {
    max-width: 90vw;
    max-height: 70vh;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    object-fit: contain;
  }

  nav {
    position: fixed;
    bottom: 12px;
    width: 100%;
    display: flex;
    justify-content: center;
    gap: 10px;
    z-index: 10;
  }

  button {
    padding: 10px 18px;
    border: none;
    border-radius: 6px;
    background-color: #9051a3;
    color: white;
    font-size: 15px;
    cursor: pointer;
  }

  button:hover:not(:disabled) {
    background-color: #9051a3;
  }

  button:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
  }

button.active {
  background-color: #5c0372; /* darker shade for active slide */
}

#percentages p {
  margin: 6px 0;
  font-size: 28px;
}

input[type=file] {
  font-size: 16px;
  margin-top: 10px;
}
 
.legend-box {
  display: inline-block;
  width: 14px;
  height: 14px;
  border: 1px solid black;
  margin-right: 2px;
  vertical-align: middle;
}

#info {
  text-align: left;
  max-width: 90vw;
  margin-top: 15px;
}

#info p {
  margin: 4px 0;
  font-size: 18px;
}

.image-name {
  margin-top: 8px;
  font-size: 16px;
  color: #333;
  text-align: center;
  word-break: break-word;
}

.emoji-list {
  list-style: none;       /* remove default bullets */
  padding-left: 0;        /* remove default padding */
  text-align: left;       /* align text to the left */
  margin: 0;
}

.emoji-list li {
  margin-bottom: 5px;     /* space between items */
  line-height: 1.4;
}


/* Hide the ugly native file input */
input[type=file] {
  display: none;
}

/* Style the custom label as a button */
.file-label {
  display: inline-block;
  border: 3px solid #282828;
  background-color: #ffffff;
  color: #282828;
  font-size: 22px;
  padding: 14px 26px;
  border-radius: 8px;
  cursor: pointer;
  margin-top: 30px;
  margin-bottom: 20px;
  text-align: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  transition: background-color 0.3s;
}

.file-label:hover {
  background-color: #ffffff;
}

.file-label:active {
  background-color: #9051a3;
}

.export-link {
  display: inline-block;
  font-size: 14px;
  color: #9051a3;
  text-decoration: underline;
  cursor: pointer;
  margin-top: 10px;
}
.export-link:hover {
  color: #5c0372;
}

@media (max-width: 600px) {
  h2 { font-size: 1.5em; }
  button { padding: 14px 22px; font-size: 18px; }
 }

</style>
</head>
<body>
  <div class="slide-container" id="slides">
    <section id="new">
      <img src="logo_and_text.png" alt="Stover logo" class="logo" width="300 px", height="auto">

      <!--<h2>Select or capture a photo</h2>
       <input type="file" id="fileInput" accept="image/*" capture="environment">
      <input type="file" id="fileInput" accept="image/*">  -->
      
      <label for="fileInput" class="file-label"><b>Upload / Capture</b></label>
      <input type="file" id="fileInput" accept="image/*">
      <p id="statusMessage" style="margin-top:5px; font-size:14px; color:#000000; font-style:italic;"></p>

      <ul class="emoji-list" style="margin-top: 30x;">
        <li><b>Tips:</b></li>
        <li>üìè Hold camera 2‚Äì3 ft (0.6‚Äì0.9 m) above ground</li>
        <li>‚òÄÔ∏è Avoid strong shadows</li>
        <li>üö´ Keep shoes, flags, and stakes out of frame</li>
        <li>üéØ Stover captures the center of the image</li>
        <li>üì≤ Offline use: Share/Menu ‚Üí ‚ÄúAdd to Home‚Äù</li>
      </ul>
    </section>

    <section id="original">
      <h2>Original Image</h2>
      <canvas id="inputCanvas"></canvas>
      <div id="info">
        <p id="imageNameOriginal" class="image-name"></p>
      </div>
    </section>

    <section id="classified">
      <h2>Classified Image</h2>
      <canvas id="outputCanvas"></canvas>
      <p style="margin:0px; font-size:0.8em; font-style: italic;">Model: unet_20250924191812</p>
      <div id="info">
        <p id="imageNameClassified" class="image-name"></p>
        <div id="percentages">Upload an image to see results.</div>
      </div>
      <a href="#" id="saveSummaryBtn" class="export-link">Export Summary</a>
    </section>

  </div>

  <nav>
    <button onclick="goToSlide(0)">New</button>
    <button id="btnOriginal" onclick="goToSlide(1)" disabled>Original</button>
    <button id="btnClassified" onclick="goToSlide(2)" disabled>Classified</button>
  </nav>

<script>
const slides = document.getElementById("slides");
const inputCanvas = document.getElementById("inputCanvas");
const outputCanvas = document.getElementById("outputCanvas");
const fileInput = document.getElementById("fileInput");
const percentagesDiv = document.getElementById("percentages");
const buttons = {
  original: document.getElementById("btnOriginal"),
  classified: document.getElementById("btnClassified"),
};

let session, lastResults = {};

async function initModel() {
  session = await ort.InferenceSession.create("unet_20250924191812.onnx");
  console.log("‚úÖ Model loaded");
}

initModel();

function goToSlide(n) {
  slides.style.transform = `translateX(-${n * 100}vw)`;

  // Highlight active button
  document.querySelectorAll("nav button").forEach((btn, i) => {
    if (i === n) btn.classList.add("active");
    else btn.classList.remove("active");
  });
}


function enableButtons() {
  buttons.original.disabled = false;
  buttons.classified.disabled = false;
}

fileInput.addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const url = URL.createObjectURL(file);
  const img = new Image();

  document.getElementById("statusMessage").textContent = "Analyzing image...";

  // Show image name
  document.getElementById("imageNameOriginal").innerHTML = `<b>File: </b> ${file.name}`;
  document.getElementById("imageNameClassified").innerHTML = `<b>File: </b> ${file.name}`;

  img.onload = async () => {
    const minSide = Math.min(img.width, img.height);
    const sx = (img.width - minSide) / 2;
    const sy = (img.height - minSide) / 2;
    const ctx = inputCanvas.getContext("2d");
    inputCanvas.width = 512;
    inputCanvas.height = 512;
    ctx.drawImage(img, sx, sy, minSide, minSide, 0, 0, 512, 512);

    enableButtons();
    goToSlide(1);
    await classifyImage();
    document.getElementById("statusMessage").textContent = "";

  };
  img.src = url;
});

async function classifyImage() {
  const ctx = inputCanvas.getContext("2d");
  const imageData = ctx.getImageData(0, 0, 512, 512);
  const { data } = imageData;
  const floatData = new Float32Array(3 * 512 * 512);

  for (let i = 0; i < 512 * 512; i++) {
    floatData[i] = data[i * 4] / 255.0;
    floatData[i + 512 * 512] = data[i * 4 + 1] / 255.0;
    floatData[i + 2 * 512 * 512] = data[i * 4 + 2] / 255.0;
  }

  const tensor = new ort.Tensor("float32", floatData, [1, 3, 512, 512]);
  const result = await session.run({ input: tensor });
  const output = result.output.data;

  const mask = new Uint8ClampedArray(512 * 512 * 4);
  const counts = [0, 0, 0]; // soil, plant, residue

  for (let i = 0; i < 512 * 512; i++) {
    const soil = output[i];
    const plant = output[i + 512 * 512];
    const residue = output[i + 2 * 512 * 512];
    const maxClass = soil > plant && soil > residue ? 0 :
                     plant > residue ? 1 : 2;
    counts[maxClass]++;

    let r=0,g=0,b=0;
    if (maxClass === 0) { r=139; g=69; b=19; }
    else if (maxClass === 1) { r=34; g=139; b=34; }
    else if (maxClass === 2) { r=255; g=215; b=0; }

    const idx = i * 4;
    mask[idx] = r; mask[idx+1] = g; mask[idx+2] = b; mask[idx+3] = 255;
  }

  outputCanvas.width = 512;
  outputCanvas.height = 512;
  outputCanvas.getContext("2d").putImageData(new ImageData(mask, 512, 512), 0, 0);

  const total = counts.reduce((a,b)=>a+b,0);
  const soilPct = (counts[0]/total*100).toFixed(1);
  const plantPct = (counts[1]/total*100).toFixed(1);
  const residuePct = (counts[2]/total*100).toFixed(1);
  const totalPct = ((counts[1] + counts[2])/total*100).toFixed(1);

  lastResults = { soilPct, plantPct, residuePct, totalPct };

  percentagesDiv.innerHTML = `
  <p><span class="legend-box" style="background-color: rgb(139,69,19);"></span><b>Soil:</b> ${soilPct}%</p>
  <p><span class="legend-box" style="background-color: rgb(34,139,34);"></span><b>Plant:</b> ${plantPct}%</p>
  <p><span class="legend-box" style="background-color: rgb(255,215,0);"></span><b>Residue:</b> ${residuePct}%</p>
  <p><b>Total cover:</b> ${totalPct}%</p>
`;
}


const saveSummaryBtn = document.getElementById("saveSummaryBtn");

saveSummaryBtn.addEventListener("click", async () => {
  const inputCanvasEl = document.getElementById("inputCanvas");
  const outputCanvasEl = document.getElementById("outputCanvas");

  // Text info
  const lines = [
    `Stover summary:`,
    `File: ${document.getElementById("imageNameClassified").textContent.replace(/^File:\s*/, '')}`, // ensure "File:" prefix
    `Soil: ${lastResults.soilPct}%`,
    `Plant: ${lastResults.plantPct}%`,
    `Residue: ${lastResults.residuePct}%`,
    `Total Cover: ${lastResults.totalPct}%`
  ];

  const lineHeight = 28;
  const padding = 20;
  const hPad = 20; // horizontal padding

  const infoHeight = lines.length * lineHeight + padding;

  const width = Math.max(inputCanvasEl.width, outputCanvasEl.width) + 2 * hPad;
  const height = inputCanvasEl.height + outputCanvasEl.height + infoHeight + 3 * padding;

  // Create offscreen canvas
  const summaryCanvas = document.createElement("canvas");
  summaryCanvas.width = width;
  summaryCanvas.height = height;
  const ctx = summaryCanvas.getContext("2d");

  // Fill background white
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0, 0, width, height);

  let y = padding;

  // Draw original image
  ctx.drawImage(inputCanvasEl, hPad, y, inputCanvasEl.width, inputCanvasEl.height);
  y += inputCanvasEl.height + padding;

  // Draw classified image
  ctx.drawImage(outputCanvasEl, hPad, y, outputCanvasEl.width, outputCanvasEl.height);
  y += outputCanvasEl.height + padding;

  // Draw info text and legend boxes
  ctx.font = "18px sans-serif";
  ctx.fillStyle = "#000000";

  // Legend colors
  const legendColors = [
    { color: "rgb(139,69,19)", label: "Soil" },
    { color: "rgb(34,139,34)", label: "Plant" },
    { color: "rgb(255,215,0)", label: "Residue" }
  ];

  // Draw File line
  ctx.fillText(lines[0], hPad, y);
  y += lineHeight;

  // Draw legend lines
  for (let i = 2; i <= 4; i++) {
    const xBox = hPad;
    const yBox = y - 18; // align with text
    ctx.fillStyle = legendColors[i-2].color;
    ctx.fillRect(xBox, yBox, 16, 16);

    ctx.fillStyle = "#000000";
    ctx.fillText(lines[i], xBox + 22, y);
    y += lineHeight;
  }

  // Draw Total Cover line
  ctx.fillText(lines[5], hPad, y);
  y += lineHeight;

  // Draw model line
  ctx.fillText("Model: unet_20250924191812", hPad, y);


  // Trigger download as JPEG
  const link = document.createElement("a");
  const now = new Date();
  const pad = n => n.toString().padStart(2, "0");
  const timestamp = now.getFullYear().toString() +
                    pad(now.getMonth() + 1) +
                    pad(now.getDate()) +
                    pad(now.getHours()) +
                    pad(now.getMinutes()) +
                    pad(now.getSeconds());
  link.download = `stover_${timestamp}.jpg`;
  link.href = summaryCanvas.toDataURL("image/jpeg", 0.95);
  link.click();
});




if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js')
    .then(() => console.log("‚úÖ Service Worker registered"))
    .catch(err => console.error("Service Worker registration failed:", err));
}

</script>

</body>
</html>
